<section class="application-overview">
    <div class="header">
        <button (click)="goBack()" class="back-button">
            <svg fill="none" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg">
                <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                      stroke-width="2"/>
            </svg>
            <span>Back to Dashboard</span>
        </button>
        <h1 class="title">{{ applicationName() }}</h1>
    </div>

    <!-- Application Summary -->
    <div class="app-summary">
        <div class="app-summary__stats">
            <div class="summary-stat">
                <svg class="summary-stat__icon" fill="none" height="24" viewBox="0 0 24 24" width="24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-linecap="round"
                          stroke-linejoin="round" stroke-width="2"/>
                    <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-linecap="round"
                          stroke-linejoin="round" stroke-width="2"/>
                </svg>
                <div class="summary-stat__content">
                    <span class="summary-stat__value">{{ formatNumber(totalUsers()) }}</span>
                    <span class="summary-stat__label">Total Users</span>
                </div>
            </div>
            <div class="summary-stat">
                <svg class="summary-stat__icon" fill="none" height="24" viewBox="0 0 24 24" width="24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2"/>
                </svg>
                <div class="summary-stat__content">
                    <span class="summary-stat__value">{{ formatNumber(totalHitsThisMonth()) }}</span>
                    <span class="summary-stat__label">Hits This Month</span>
                </div>
            </div>
            <div class="summary-stat">
                <svg class="summary-stat__icon" fill="none" height="24" viewBox="0 0 24 24" width="24"
                     xmlns="http://www.w3.org/2000/svg">
                    <rect height="14" rx="2" ry="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20"
                          x="2" y="3"/>
                    <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2"/>
                </svg>
                <div class="summary-stat__content">
                    <span class="summary-stat__value">{{ environmentCount() }}</span>
                    <span class="summary-stat__label">Environments</span>
                </div>
            </div>
        </div>

        <!-- Pricing Breakdown -->
        <div class="pricing-breakdown">
            <div class="pricing-breakdown__header">
                <h3 class="pricing-breakdown__title">Monthly Price Breakdown</h3>
                <span class="pricing-breakdown__total">
          ${{ applicationTotalMonthlyPrice() }}<span class="pricing-breakdown__period">/mo</span>
        </span>
            </div>

            <div class="pricing-chart">
                <!-- Environment fees row -->
                @if (additionalEnvironmentFees() > 0) {
                    <div class="pricing-chart__row">
                        <div class="pricing-chart__label">
                            <span class="pricing-chart__name">Environment Fees</span>
                            <span class="pricing-chart__detail">{{ environmentCount() - 1 }}
                                additional Ã— ${{ environmentFee }}</span>
                        </div>
                        <div class="pricing-chart__bar-wrapper">
                            <div
                                    class="pricing-chart__bar pricing-chart__bar--fee"
                                    [style.width.%]="(additionalEnvironmentFees() / applicationTotalMonthlyPrice()) * 100">
                            </div>
                        </div>
                        <span class="pricing-chart__amount">${{ additionalEnvironmentFees() }}</span>
                    </div>
                }

                <!-- Environment rows -->
                @for (env of pricingBreakdown(); track env.id) {
                    <div class="pricing-chart__row"
                         [class.pricing-chart__row--active]="selectedEnvironment()?.id === env.id">
                        <div class="pricing-chart__label">
                            <span class="pricing-chart__name">{{ env.name }}</span>
                          @if (env.description) {
                                <span class="pricing-chart__detail">{{ env.description }}</span>
                            }
                        </div>
                        <div class="pricing-chart__bar-wrapper">
                            @if (env.total > 0) {
                                <div
                                        class="pricing-chart__bar pricing-chart__bar--requests"
                                        [style.width.%]="(env.requestTierPrice / applicationTotalMonthlyPrice()) * 100">
                                </div>
                                <div
                                        class="pricing-chart__bar pricing-chart__bar--users"
                                        [style.width.%]="(env.userTierPrice / applicationTotalMonthlyPrice()) * 100">
                                </div>
                            }
                        </div>
                        <span class="pricing-chart__amount">
              @if (env.tier === 'FREE') {
                  Free
              } @else if (env.total === 0) {
                  $0
              } @else {
                  ${{ env.total }}
              }
            </span>
                    </div>
                }
            </div>

            <!-- Legend -->
            <div class="pricing-legend">
                <div class="pricing-legend__item">
                    <span class="pricing-legend__dot pricing-legend__dot--fee"></span>
                    <span class="pricing-legend__text">Environment fees</span>
                </div>
                <div class="pricing-legend__item">
                    <span class="pricing-legend__dot pricing-legend__dot--requests"></span>
                    <span class="pricing-legend__text">Request limits</span>
                </div>
                <div class="pricing-legend__item">
                    <span class="pricing-legend__dot pricing-legend__dot--users"></span>
                    <span class="pricing-legend__text">User limits</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Environment Selection -->
    @if (application()?.id) {
        <app-environment-manager
                (environmentCreated)="onEnvironmentCreated($event)"
                (environmentDeleted)="onEnvironmentDeleted($event)"
                [(selectedEnvironment)]="selectedEnvironment"
                [applicationId]="application()!.id!"
                [applicationName]="applicationName()"
                [environments]="environments()">
        </app-environment-manager>
    }

    <!-- Environment Details -->
    @if (selectedEnvironment()) {
      <!-- Tab Navigation -->
      <div class="tab-bar">
        <button class="tab-bar__tab"
                [class.tab-bar__tab--active]="activeTab() === 'overview'"
                (click)="setActiveTab('overview')">
          Overview
        </button>
        <button class="tab-bar__tab"
                [class.tab-bar__tab--active]="activeTab() === 'configuration'"
                (click)="setActiveTab('configuration')">
          Template
        </button>
        <button class="tab-bar__tab"
                [class.tab-bar__tab--active]="activeTab() === 'overrides'"
                (click)="setActiveTab('overrides')">
          Overrides
          @if (hasIdentifierOverrides()) {
            <span class="tab-bar__badge">{{ matrixIdentifiers().length }}</span>
          }
        </button>
      </div>

      <!-- Overview Tab Content -->
      @if (activeTab() === 'overview') {
        <div class="content">
            <div class="overview-cards">
              <div class="overview-card template-card" [class.template-card--collapsed]="!apiAttributesExpanded()">
                <button class="overview-card__header template-card__header" (click)="toggleApiAttributesCard()">
                  <div class="template-card__header-left">
                    <svg class="template-card__chevron" [class.template-card__chevron--open]="apiAttributesExpanded()"
                         width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round"/>
                    </svg>
                    <h3 class="overview-card__title">API Attributes</h3>
                  </div>
                </button>
                @if (apiAttributesExpanded()) {
                    <div class="overview-card__content">
                        <div class="stat">
                            <span class="stat__label">Identifier</span>
                            <code class="stat__code">{{ environmentIdentifier() }}</code>
                        </div>

                        <!-- API Keys Component -->
                        @if (application()?.id && selectedEnvironment()?.id) {
                            <app-api-keys-card
                                    [applicationId]="application()!.id!"
                                    [environmentId]="selectedEnvironment()!.id!">
                            </app-api-keys-card>
                        }

                      <!-- Rate Limit Tier (Admin only) -->
                      <div *hasRole="CustomerRole.Admin" class="tier-section">
                        <span class="tier-section__label">Rate Limit</span>
                        <div class="tier-slider-wrapper">
                          <div class="tier-slider">
                            <div class="tier-slider__track tier-slider__track--five">
                              <input
                                (input)="onRateLimitTierSliderChange($event)"
                                [max]="rateLimitTiers().length - 1"
                                [value]="selectedRateLimitTierIndex()"
                                aria-label="Select rate limit tier"
                                class="tier-slider__input"
                                min="0"
                                type="range">
                              <div class="tier-slider__labels tier-slider__labels--five">
                                @for (tier of rateLimitTiers(); track tier.id; let i = $index) {
                                  <button
                                    (click)="selectedRateLimitTierIndex.set(i)"
                                    [class.tier-slider__tick--active]="i === selectedRateLimitTierIndex()"
                                    class="tier-slider__tick">
                                    {{ tier.name }}
                                  </button>
                                }
                              </div>
                            </div>
                            <div class="tier-display">
                              <div class="tier-display__main">
                                <span
                                  class="tier-display__limit-value">{{ formatRateLimit(currentRateLimitTier().rateLimit) }}</span>
                                <span class="tier-display__limit-label">req/sec</span>
                                        </div>
                              <div class="tier-display__details">
                                <span class="tier-display__price">{{ currentRateLimitTier().price }}<span
                                  class="tier-display__period">/env/mo</span></span>
                                <span
                                  class="tier-display__requests">{{ currentRateLimitTier().requestsPerMonth }}</span>
                              </div>
                            </div>
                          </div>
                            </div>
                        </div>
                    </div>
                }
                </div>

                @if (selectedEnvironment()?.id) {
                    <app-usage-stats-card
                            [environmentId]="selectedEnvironment()!.id!">
                    </app-usage-stats-card>
                }
            </div>
        </div>
      }

      <!-- Configuration Tab Content -->
      @if (activeTab() === 'configuration') {
        @if (application()?.id) {
            <app-template-config
                    (navigateToOverrides)="onNavigateToOverrides($event)"
                    (templateChanged)="onTemplateChanged()"
                    [(templateType)]="templateTemplateType"
                    [applicationId]="application()!.id!"
                    [applicationName]="applicationName()"
                    [hasIdentifierOverrides]="hasIdentifierOverrides()"
                    [systemOverrideCount]="systemOverrideCount()"
                    [systemTemplate]="systemTemplate()"
                    [userOverrideCount]="userOverrideCount()"
                    [userTemplate]="userTemplate()">
            </app-template-config>
        }
      }

      <!-- Overrides Tab Content -->
      @if (activeTab() === 'overrides') {
        @if (application()?.id && selectedEnvironment()?.id) {
            <app-override-manager
                    (overridesChanged)="onOverridesChanged()"
                    [(templateType)]="overridesTemplateType"
                    [applicationId]="application()!.id!"
                    [applicationName]="applicationName()"
                    [environmentId]="selectedEnvironment()!.id!"
                    [environments]="environments()"
                    [systemOverrides]="systemOverrides()"
                    [systemTemplate]="systemTemplate()"
                    [userOverrides]="userOverrides()"
                    [userTemplate]="userTemplate()">
            </app-override-manager>
        }
      }
    }
</section>

