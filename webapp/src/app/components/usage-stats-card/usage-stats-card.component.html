<div [class.template-card--collapsed]="!expanded()" class="usage-stats-card template-card">
  <button (click)="toggleCard()" class="usage-stats-card__header template-card__header">
    <div class="template-card__header-left">
      <svg [class.template-card__chevron--open]="expanded()" class="template-card__chevron"
           fill="none" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2"/>
      </svg>
      <h3 class="usage-stats-card__title">Usage Overview</h3>
    </div>
    <div (click)="$event.stopPropagation()" class="usage-stats-card__period-selector">
      <button (click)="setDays(7)" [class.active]="selectedDays() === 7">7d</button>
      <button (click)="setDays(15)" [class.active]="selectedDays() === 15">15d</button>
      <button (click)="setDays(30)" [class.active]="selectedDays() === 30">30d</button>
    </div>
  </button>
  @if (expanded()) {
    <div class="usage-stats-card__content">
      @if (loading()) {
        <div class="usage-chart__loading">
          <span>Loading statistics...</span>
        </div>
      } @else if (dailyStats().length === 0) {
        <div class="usage-chart__empty">
          <span>No usage data available yet</span>
        </div>
      } @else {
        <!-- Usage Chart -->
        <div class="usage-chart">
          <div class="usage-chart__bars">
            @for (stat of dailyStats(); track stat.date) {
              <div [title]="formatNumber(stat.totalRequests ?? 0) + ' requests'" class="usage-chart__bar-container">
                <div
                  [style.height.%]="getBarHeight(stat.totalRequests)"
                  class="usage-chart__bar">
                </div>
                <span class="usage-chart__label">{{ stat.date | date:'EEE' }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="usage-stats">
          <div class="usage-stat">
            <span class="usage-stat__value">{{ formatNumber(todayStats()?.totalRequests ?? 0) }}</span>
            <span class="usage-stat__label">Requests today</span>
          </div>

          <div class="usage-stat">
            <span class="usage-stat__value">{{ todayStats()?.peakRequestsPerSecond ?? 0 }}<span
              class="usage-stat__unit">req/s</span></span>
            <span class="usage-stat__label">Peak req/sec today</span>
          </div>

          <div class="usage-stat">
            <span class="usage-stat__value">{{ formatDecimal(todayStats()?.avgRequestsPerSecond) }}<span
              class="usage-stat__unit">req/s</span></span>
            <span class="usage-stat__label">Avg req/sec today</span>
          </div>

          <div [class.usage-stat--warning]="rejectionRate() > 0" class="usage-stat">
            <span class="usage-stat__value">
              {{ formatNumber(todayStats()?.rejectedRequests ?? 0) }}
              @if (rejectionRate() > 0) {
                <span class="usage-stat__unit">({{ rejectionRate() | number:'1.1-1' }}%)</span>
              }
            </span>
            <span class="usage-stat__label">Rejected today</span>
          </div>

          <div class="usage-stat">
            <span class="usage-stat__value">{{ formatNumber(totalRequests()) }}</span>
            <span class="usage-stat__label">Total ({{ selectedDays() }} days)</span>
          </div>
        </div>
      }
    </div>
  }
</div>
