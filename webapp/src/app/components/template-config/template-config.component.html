<div class="template-tab">
  <!-- Controls Bar -->
  <div class="template-controls">
    <div class="template-controls__left">
      <!-- Template Type Toggle -->
      <div class="template-toggle">
        <button (click)="templateType.set('system')"
                [class.template-toggle__btn--active]="templateType() === 'system'"
                class="template-toggle__btn">
          System
          <span class="template-toggle__count">{{ systemTemplateFields().length }}</span>
        </button>
        <button (click)="templateType.set('user')"
                [class.template-toggle__btn--active]="templateType() === 'user'"
                class="template-toggle__btn">
          User
          <span class="template-toggle__count">{{ userTemplateFields().length }}</span>
        </button>
      </div>

      <!-- Search -->
      <div class="template-search">
        <svg class="template-search__icon" fill="none" height="16" viewBox="0 0 24 24" width="16">
          <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
          <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-linecap="round" stroke-width="2"/>
        </svg>
        <input (ngModelChange)="searchQuery.set($event)"
               [ngModel]="searchQuery()"
               class="template-search__input"
               placeholder="Search fields..."
               type="text">
      </div>
    </div>

    <div class="template-controls__right">
      <!-- Filter: Show fields with defaults -->
      <label class="template-checkbox">
        <input (change)="showFieldsWithDefaults.set($any($event.target).checked)"
               [checked]="showFieldsWithDefaults()"
               type="checkbox">
        <span class="template-checkbox__label">With values only</span>
      </label>

      <!-- Add Field Button (Dev and Admin only) -->
      @if (roleService.canManageTemplates()) {
        <button (click)="openAddFieldOverlay(templateType())"
                class="btn btn-primary btn-sm btn-icon">
          <svg fill="none" height="16" viewBox="0 0 16 16" width="16">
            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-linecap="round" stroke-width="2"/>
          </svg>
          Add Field
        </button>
      }
    </div>
  </div>

  <!-- System Template Table -->
  @if (templateType() === 'system') {
    @if (filteredSystemTemplateFields().length > 0) {
      <div class="template-matrix-wrapper">
        <table class="template-matrix-table">
          <thead>
          <tr>
            <th class="template-matrix-table__header template-matrix-table__header--sticky">Field</th>
            <th class="template-matrix-table__header">Type</th>
            <th class="template-matrix-table__header">Default</th>
            <th class="template-matrix-table__header">Description</th>
            <th class="template-matrix-table__header">Constraints</th>
            @if (roleService.canManageTemplates()) {
              <th class="template-matrix-table__header template-matrix-table__header--actions"></th>
            }
          </tr>
          </thead>
          <tbody>
            @for (field of filteredSystemTemplateFields(); track field.key) {
              <tr class="template-matrix-table__row">
                <!-- Field Key (sticky) -->
                <td class="template-matrix-table__cell template-matrix-table__cell--sticky">
                  <code class="template-matrix-table__field-name">
                    {{ field.key }}
                  </code>
                </td>
                <!-- Type -->
                <td class="template-matrix-table__cell">
                          <span class="template-matrix-table__type template-matrix-table__type--{{ field.type }}">
                            {{ field.type }}
                          </span>
                </td>
                <!-- Default Value -->
                <td class="template-matrix-table__cell">
                <span class="template-matrix-table__value">
                  {{ getFieldDefaultValue(field) || '—' }}
                </span>
                </td>
                <!-- Description -->
                <td class="template-matrix-table__cell template-matrix-table__cell--description">
                <span class="template-matrix-table__description">
                  {{ field.description || '—' }}
                </span>
                </td>
                <!-- Constraints (read-only) -->
                <td class="template-matrix-table__cell template-matrix-table__cell--constraints">
                  {{ formatConstraints(field) || '—' }}
                </td>
                <!-- Actions (Dev and Admin only) -->
                @if (roleService.canManageTemplates()) {
                  <td class="template-matrix-table__cell template-matrix-table__cell--actions">
                    <button (click)="openEditFieldOverlay(field, 'system')"
                            class="template-matrix-table__action-btn"
                            title="Edit field">
                      <svg fill="none" height="16" viewBox="0 0 16 16" width="16">
                        <path
                          d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.00001 13.6667L1.33334 14.6667L2.33334 11L11.333 2.00004Z"
                          stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="1.5"/>
                      </svg>
                    </button>
                    <button (click)="openDeleteFieldOverlay(field.key!, 'system')"
                            class="template-matrix-table__delete-btn"
                            title="Delete field">
                      <svg fill="none" height="16" viewBox="0 0 16 16" width="16">
                        <path d="M4 4L12 12M12 4L4 12" stroke="currentColor" stroke-linecap="round"
                              stroke-width="2"/>
                      </svg>
                    </button>
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>

    } @else {
      <div class="template-empty">
        <svg fill="none" height="48" viewBox="0 0 24 24" width="48">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-2h-2v2zm0-4h2V7h-2v6z"
            fill="currentColor" opacity="0.3"/>
        </svg>
        @if (searchQuery()) {
          <p>No matching system fields found.</p>
          <p class="template-empty__hint">Try adjusting your search criteria.</p>
        } @else {
          <p>No system template fields configured.</p>
          <p class="template-empty__hint">Add fields to define system-level configuration.</p>
        }

      </div>
    }

    <!-- Link to Overrides -->
    @if (hasIdentifierOverrides() && systemOverrideCount() > 0) {
      <div class="template-overrides-link">
        <button (click)="onNavigateToOverrides('system')"
                class="template-overrides-link__btn">
                                <span class="template-overrides-link__text">
                                    {{ systemOverrideCount() }} identifier(s) with system overrides
                                </span>
          <svg fill="none" height="16" viewBox="0 0 20 20" width="16">
            <path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-linecap="round" stroke-width="2"/>
          </svg>
        </button>
      </div>
    }
  }

  <!-- User Template Table -->
  @if (templateType() === 'user') {
    @if (filteredUserTemplateFields().length > 0) {
      <div class="template-matrix-wrapper">
        <table class="template-matrix-table template-matrix-table--user">
          <thead>
          <tr>
            <th class="template-matrix-table__header template-matrix-table__header--sticky">Field</th>
            <th class="template-matrix-table__header">Type</th>
            <th class="template-matrix-table__header template-matrix-table__header--editable">Editable</th>
            <th class="template-matrix-table__header">Default</th>
            <th class="template-matrix-table__header">Description</th>
            <th class="template-matrix-table__header">Constraints</th>
            @if (roleService.canManageTemplates()) {
              <th class="template-matrix-table__header template-matrix-table__header--actions"></th>
            }
          </tr>
          </thead>
          <tbody>
            @for (field of filteredUserTemplateFields(); track field.key) {
              <tr class="template-matrix-table__row">
                <!-- Field Key (sticky) -->
                <td class="template-matrix-table__cell template-matrix-table__cell--sticky">
                  <code class="template-matrix-table__field-name">
                    {{ field.key }}
                  </code>
                </td>
                <!-- Type -->
                <td class="template-matrix-table__cell">
                          <span class="template-matrix-table__type template-matrix-table__type--{{ field.type }}">
                            {{ field.type }}
                          </span>
                </td>
                <!-- Editable -->
                <td class="template-matrix-table__cell template-matrix-table__cell--editable">
                          <span [class.template-matrix-table__toggle--active]="field.editable"
                                class="template-matrix-table__toggle">
                            @if (field.editable) {
                              <svg fill="none" height="16" viewBox="0 0 16 16" width="16">
                                <path d="M13.5 4.5L6 12L2.5 8.5" stroke="currentColor" stroke-linecap="round"
                                      stroke-linejoin="round" stroke-width="2"/>
                              </svg>
                            } @else {
                              <svg fill="none" height="16" viewBox="0 0 16 16" width="16">
                                <path d="M4 4L12 12M12 4L4 12" stroke="currentColor" stroke-linecap="round"
                                      stroke-width="2"/>
                              </svg>
                            }
                          </span>
                </td>
                <!-- Default Value -->
                <td class="template-matrix-table__cell">
                <span class="template-matrix-table__value">
                  {{ getFieldDefaultValue(field) || '—' }}
                </span>
                </td>
                <!-- Description -->
                <td class="template-matrix-table__cell template-matrix-table__cell--description">
                <span class="template-matrix-table__description">
                  {{ field.description || '—' }}
                </span>
                </td>
                <!-- Constraints (read-only) -->
                <td class="template-matrix-table__cell template-matrix-table__cell--constraints">
                  {{ formatConstraints(field) || '—' }}
                </td>
                <!-- Actions (Dev and Admin only) -->
                @if (roleService.canManageTemplates()) {
                  <td class="template-matrix-table__cell template-matrix-table__cell--actions">
                    <button (click)="openEditFieldOverlay(field, 'user')"
                            class="template-matrix-table__action-btn"
                            title="Edit field">
                      <svg fill="none" height="16" viewBox="0 0 16 16" width="16">
                        <path
                          d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.00001 13.6667L1.33334 14.6667L2.33334 11L11.333 2.00004Z"
                          stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="1.5"/>
                      </svg>
                    </button>
                    <button (click)="openDeleteFieldOverlay(field.key!, 'user')"
                            class="template-matrix-table__delete-btn"
                            title="Delete field">
                      <svg fill="none" height="16" viewBox="0 0 16 16" width="16">
                        <path d="M4 4L12 12M12 4L4 12" stroke="currentColor" stroke-linecap="round"
                              stroke-width="2"/>
                      </svg>
                    </button>
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
    } @else {
      <div class="template-empty">
        <svg fill="none" height="48" viewBox="0 0 24 24" width="48">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-2h-2v2zm0-4h2V7h-2v6z"
            fill="currentColor" opacity="0.3"/>
        </svg>
        @if (searchQuery()) {
          <p>No matching user fields found.</p>
          <p class="template-empty__hint">Try adjusting your search criteria.</p>
        } @else {
          <p>No user template fields configured.</p>
          <p class="template-empty__hint">Add fields to define user-level configuration.</p>
        }
      </div>
    }

    <!-- Link to Overrides -->
    @if (hasIdentifierOverrides() && userOverrideCount() > 0) {
      <div class="template-overrides-link">
        <button (click)="onNavigateToOverrides('user')"
                class="template-overrides-link__btn">
                                <span class="template-overrides-link__text">
                                    {{ userOverrideCount() }} identifier(s) with user overrides
                                </span>
          <svg fill="none" height="16" viewBox="0 0 20 20" width="16">
            <path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-linecap="round" stroke-width="2"/>
          </svg>
        </button>
      </div>
    }
  }
</div>
